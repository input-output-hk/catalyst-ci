VERSION 0.7

# cspell: words psql

# Internal: builder is our Event db builder target. Prepares all necessary artifacts.
#   CI target : dependency
builder:
    FROM ./../../earthly/postgresql+postgres-base

    WORKDIR /build

    COPY ./../../+repo-config/repo/.sqlfluff .
    COPY --dir ./migrations ./seed ./refinery.toml .
    DO ./../../earthly/postgresql+BUILDER

# check if the sql files are properly formatted and pass lint quality checks.
#   CI target : true
check:
    FROM +builder

    DO ./../../earthly/postgresql+CHECK

# Internal: build-sqlfluff is a target to build the necessary `sqlfluff` tool container.
#   CI target : false
# This allows us to run sqlfluff commands locally without needing to install it locally.
# It does not need to be run directly, it is used by the `format` target.
build-sqlfluff:
    BUILD ./../../earthly/postgresql+sqlfluff-image   

# format all SQL files in the current project.  Local developers tool.
#   CI target : false
format:
    LOCALLY

    # This is a trick.  Earthly can NOT build and run a container in the same invocation.
    # Because this target is running LOCALLY, and we know earthly must be installed, we can
    # call earthly locally to build and publish the local target we need to run the sqlfluff linter.
    # By recursively running earthly, we sidestep the limitation which prevents us from building 
    # a container and running it in the same invocation.
    RUN earthly +build-sqlfluff

    DO ./../../earthly/postgresql+FORMAT --src=$(echo ${PWD})


# build an event db docker image.
#   CI target : true
build:
    FROM +builder

    DO ./../../earthly/postgresql+BUILD --image_name=example-db

# Internal: Test Scenario 1
#   CI target : true
# Steps:
#   * Container runs PostgreSQL server
#   * drops and initialise db
#   * applies migrations
#   * applies seed data.
test-1:
    FROM ./../../earthly/postgresql+postgres-base

    COPY ./../../earthly/utils+shell-assert/assert.sh .

    ENV INIT_AND_DROP_DB true
    ENV WITH_MIGRATIONS true
    ENV WITH_SEED_DATA true
    COPY ./docker-compose.yml .
    WITH DOCKER \
        --compose docker-compose.yml \
        --load example-db:latest=+build \
        --service example \
        --allow-privileged
        RUN sleep 5;\
            res=$(psql postgresql://example-dev:example-pass@0.0.0.0:5432/ExampleDb -c "SELECT * FROM users");\
            
            source assert.sh;\
            expected=$(printf "  name   | age \n---------+-----\n Alice   |  20\n Bob     |  30\n Charlie |  40\n(3 rows)");\
            assert_eq "$expected" "$res"
    END

# Internal: Test Scenario 2
#   CI target : dependency
# Steps:
#   * Container runs PostgreSQL server
#   * drops and initialise db
#   * doesn't apply migrations
#   * doesn't apply seed data.
test-2:
    FROM ./../../earthly/postgresql+postgres-base

    ENV INIT_AND_DROP_DB true
    ENV WITH_MIGRATIONS false
    ENV WITH_SEED_DATA false
    COPY ./docker-compose.yml .
    WITH DOCKER \
        --compose docker-compose.yml \
        --load example-db:latest=+build \
        --service example \
        --allow-privileged
        RUN sleep 5;\
            ! psql postgresql://example-dev:example-pass@0.0.0.0:5432/ExampleDb -c "SELECT * FROM users"
    END

# Internal: Test Scenario 3
#   CI target : dependency
# Steps:
#   * Container runs PostgreSQL server
#   * drops and initialise db
#   * applies migrations
#   * doesn't apply seed data.
test-3:
    FROM ./../../earthly/postgresql+postgres-base

    COPY ./../../earthly/utils+shell-assert/assert.sh .

    ENV INIT_AND_DROP_DB true
    ENV WITH_MIGRATIONS true
    ENV WITH_SEED_DATA false
    COPY ./docker-compose.yml .
    WITH DOCKER \
        --compose docker-compose.yml \
        --load example-db:latest=+build \
        --service example \
        --allow-privileged
        RUN sleep 5;\
            res=$(psql postgresql://example-dev:example-pass@0.0.0.0:5432/ExampleDb -c "SELECT * FROM users");\

            source assert.sh;\
            expected=$(printf " name | age \n------+-----\n(0 rows)");\
            assert_eq "$expected" "$res"
    END

# Internal: Test Scenario 4
#   CI target : dependency
# Steps:
#   * PostgreSQL server runs as a separate service
#   * drops and initialise db
#   * applies migrations
#   * applies seed data.
test-4:
    FROM ./../../earthly/postgresql+postgres-base

    COPY ./../../earthly/utils+shell-assert/assert.sh .

    ENV DB_HOST postgres
    ENV INIT_AND_DROP_DB true
    ENV WITH_MIGRATIONS true
    ENV WITH_SEED_DATA true
    COPY ./docker-compose.yml .
    WITH DOCKER \
        --compose docker-compose.yml \
        --pull postgres:16 \
        --load example-db:latest=+build \
        --service example \
        --service postgres \
        --allow-privileged
        RUN sleep 5;\
            res=$(psql postgresql://postgres:postgres@0.0.0.0:5433/ExampleDb -c "SELECT * FROM users");\
            
            source assert.sh;\
            expected=$(printf "  name   | age \n---------+-----\n Alice   |  20\n Bob     |  30\n Charlie |  40\n(3 rows)");\
            assert_eq "$expected" "$res"
    END

# test the event db database schema. Invokes all tests.
#   CI target : true
test:
    BUILD +test-1
    BUILD +test-2
    BUILD +test-3
    BUILD +test-4
