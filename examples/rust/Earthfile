VERSION 0.7

# cspell: words TARGETARCH USERARCH toolsets rustfmt

# Set up our target toolchains, and copy our files.
builder:
    FROM ./../../earthly/rust+rust-base

    COPY --dir .cargo .config crates .
    COPY Cargo.lock Cargo.toml .
    COPY clippy.toml deny.toml rustfmt.toml .

    DO ./../../earthly/rust+SETUP

# Test rust build container - Use best architecture host tools.
hosted-check:
    FROM +builder

    DO ./../../earthly/rust+CHECK

# Test which runs check with all supported host tooling.  Needs qemu or rosetta to run.
# Only used to validate tooling is working across host toolsets.
all-hosts-check:    
    BUILD --platform=linux/amd64 --platform=linux/arm64 +hosted-check


# Build the service.
hosted-build:
    FROM +builder
 
    DO ./../../earthly/rust+BUILD --libs="bar" --bins="foo/foo"

    DO ./../../earthly/rust+SMOKE_TEST --bin="foo"

    SAVE ARTIFACT target/$TARGETARCH/doc doc
    SAVE ARTIFACT target/$TARGETARCH/release/foo foo

# Test which runs check with all supported host tooling.  Needs qemu or rosetta to run.
# Only used to validate tooling is working across host toolsets.
all-hosts-build:    
    BUILD --platform=linux/amd64 --platform=linux/arm64 +hosted-build

## -----------------------------------------------------------------------------
##
## Standard CI targets.
##
## These targets are discovered and executed automatically by CI.

# Run check using the most efficient host tooling
# CI Automated Entry point.
check:
    FROM busybox
    # This is necessary to pick the correct architecture build to suit the native machine.
    # It primarily ensures that Darwin/Arm builds work as expected without needing x86 emulation.
    # All target implementation of this should follow this pattern.
    ARG USERARCH

    IF [ "$USERARCH" == "arm64" ]
        BUILD --platform=linux/arm64 +hosted-check
    ELSE
        BUILD --platform=linux/amd64 +hosted-check
    END

# Run build using the most efficient host tooling
# CI Automated Entry point.
build:
    FROM busybox
    # This is necessary to pick the correct architecture build to suit the native machine.
    # It primarily ensures that Darwin/Arm builds work as expected without needing x86 emulation.
    # All target implementation of this should follow this pattern.
    ARG USERARCH

    IF [ "$USERARCH" == "arm64" ]
        BUILD --platform=linux/arm64 +hosted-build
    ELSE
        BUILD --platform=linux/amd64 +hosted-build
    END

# This step simulates the full CI run for local purposes only.
local-ci-run:
    BUILD +check
    BUILD +build