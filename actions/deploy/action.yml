name: CI Deploy
description: Deploys the published images to the remote cluster.
inputs:
  deployment_repo:
    description: The URL of the repository containing deployment code
    required: true
  discover_output:
    description: The output from the discover step
    required: true
  environment:
    description: The target environment to deploy to
    required: true
  tag:
    description: The image tag to deploy
    required: true
  token:
    description: Github token for accessing deployment repo
    required: true

runs:
  using: composite
  steps:
    - name: Checkout deployment repository
      uses: actions/checkout@v3
      with:
        repository: ${{ inputs.deployment_repo }}
        ref: deployment # TODO: Remove me
        token: ${{ inputs.token }}
    - name: Update deployment hashes
      shell: bash
      id: discover
      run: |
        CHANGES=$(echo '${{ inputs.discover_output }}' | jq -cr 'map({(.images | split(" ")[] ): "${{ inputs.tag }}"}) | add')
        echo "${CHANGES}" > /tmp/changes.json

        HASHES=src/kube/environments/${{ inputs.environment }}/hashes.json
        FINAL=$(jq -s '.[0] * .[1]' "$HASHES" /tmp/changes.json)
        echo "$FINAL" > "$HASHES"

        echo "Final:"
        cat "$HASHES"

        git config --global user.email "ci@projectcatalyst.io"
        git config --global user.name "catalyst-cibot"
        git add "$HASHES"
        git --no-pager diff
        git commit -m "chore: updates deployments"
