VERSION 0.7
FROM python:3.12-alpine3.18

# cspell: words libgcc freetype lcms openjpeg

mkdocs-material:
    # Derived from official mkdocs-material docker container.
    # https://github.com/squidfunk/mkdocs-material/blob/master/Dockerfile
    # Due to docs being constructed not only from Doc source but Build artifacts,
    # These docs do NOT support Live serving, and must be built.
    # This is all the tooling needed to build the docs.

    # Install extra packages we will need to support plugins.
    RUN apk add --no-cache \    
        bash \
        graphviz \
        curl \
        zlib-dev \
        jpeg-dev \
        libxml2-dev \
        libxslt-dev \
        libffi-dev \
        gcc \
        musl-dev \
        libgcc \
        openssl-dev \
        freetype-dev \
        lcms2-dev \
        openjpeg-dev \
        tiff-dev \
        tk-dev \
        tcl-dev  \
        git       

    # Install poetry and our python dependencies.
    DO ../python+POETRY_SETUP

    # Copy our run scripts
    COPY --dir scripts /scripts

    # Trust directory, required for git >= 2.35.2. (mkdocs Git plugin requirement).
    RUN git config --global --add safe.directory /docs &&\
        git config --global --add safe.directory /site

    # Set working directory
    WORKDIR /docs

    # Live Docs are not supported, this is only used during testing.

    # Expose MkDocs development server port
    EXPOSE 8000

    # Start development server by default
    # Will live serve the docs in `/docs` on 0.0.0.0:8000
    ENTRYPOINT ["/scripts/serve.sh"]

# Build the docs - We always do this in a `docs` target.  
# The only target that needs customizing is the `src` target.
BUILD:
    COMMAND

    FROM +src

    RUN /scripts/build.sh

    SAVE ARTIFACT /site/*


# See `<repo>/docs` for the example docs project which uses this tooling.

# Docs fall outside the normal CI flow and have their own build and publish flow.

# We do however build a docs package which is used for locally serving the docs
# which assists in documentation writing.
PACKAGE:
    COMMAND
    ARG image_name

    # Use the official Nginx base image
    FROM nginx:alpine3.18-slim

    # make sure docs are built.
    BUILD +docs

    # Copy the static pages into the container
    COPY +docs/ /usr/share/nginx/html

    # Expose port 80 for HTTP traffic
    EXPOSE 80

    # Start Nginx when the container is run
    CMD ["nginx", "-g", "daemon off;"]

    SAVE IMAGE cat-voices-docs:latest    
    