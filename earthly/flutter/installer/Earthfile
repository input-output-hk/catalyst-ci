VERSION 0.8

# cspell: words Rxxxx

# An AWS S3 bucket is used to store browser and driver packages. 
# Packages are updated automatically once a week. 
# You can download the version of packages you need using the pipeline https://github.com/input-output-hk/catalyst-storage/actions/workflows/download-browsers.yml.
# There are some limitation in pipeline:
# - for firefox you need to specify full version name with "esr" key word (e.g. 115.15.0esr-1)
# - latest geckodriver will be downloaded together with firefox
# Not all version can be installed due to library dependencies.
# Starting from this version, INSTALL_CHROME_LINUX64, INSTALL_FIREFOX_LINUX64, INSTALL_EDGE_LINUX64, INSTALL_CHROMIUM require specifying the browser version.
ARG --global BASE_URL = "https://iog-catalyst-storage.s3.eu-central-1.amazonaws.com"

#TODO(minikin): https://github.com/input-output-hk/catalyst-storage/issues/1

# Install Chrome/Chromium for testing and Chromedriver.
# There is no Chrome-for-testing build for linux/arm64, using Chromium instead.
# https://github.com/GoogleChromeLabs/chrome-for-testing/issues/1
# Define a function to install Chrome or Chromium based on the target architecture.
INSTALL_CHROME_LINUX64:
    FUNCTION

    ARG --required version
    ARG TARGETARCH
    LET BLUE='\033[0;34m'

    # TARGETARCH is the target processor architecture for which the target is being built.
    # WARNING: The value of a built-in arg (earthly) can never be overridden!
    # You must provide it as ARG, e.g., `ARG TARGETARCH` in your function to use it.
    # Read more about it here: https://docs.earthly.dev/docs/earthfile/builtin-args#platform-related-args
    IF [ "$TARGETARCH" = "amd64" ]
        RUN printf "${BLUE} Installing Google Chrome..." \
            && curl -sSL -o /opt/chrome.zip "${BASE_URL}/chrome/${version}/chrome_amd64.zip" \
            && unzip /opt/chrome.zip -d /opt/chrome \
            && gdebi -n /opt/chrome/chrome_amd64.deb \
            && rm -rf /opt/chrome*
        RUN google-chrome --version
        DO +PATCH_CHROME --BIN_TO_PATCH="google-chrome"

        RUN printf "${BLUE} Installing Chromedriver..." \
            && curl -sSL -o /opt/chromedriver.zip "${BASE_URL}/chrome/${version}/chromedriver-linux64.zip" \
            && unzip -j /opt/chromedriver.zip -d /usr/local/bin/ \
            && rm -rf /opt/chromedriver.zip
        RUN chromedriver --version

    ELSE
        DO +INSTALL_CHROMIUM --version=$version --PACKAGE_TYPE="chromium" --DOWNLOAD_URL="${BASE_URL}/chromium/${version}/chromium_${TARGETARCH}.zip"
        RUN chromium --version
        DO +PATCH_CHROME --BIN_TO_PATCH="chromium"

        DO +INSTALL_CHROMIUM --version=$version --PACKAGE_TYPE="chromium-driver" --DOWNLOAD_URL="${BASE_URL}/chromium/${version}/chromium-driver-${TARGETARCH}.zip"
        RUN chromedriver --version
    END

# Install Firefox and Geckodriver from AWS S3 bucket.
# Geckodriver supported versions:
# https://firefox-source-docs.mozilla.org/testing/geckodriver/Support.html
INSTALL_FIREFOX_LINUX64:
    FUNCTION

    ARG --required version
    ARG TARGETARCH
    LET PLATFORM = ""
    LET BLUE = '\033[0;34m'

    RUN printf "${BLUE} Installing Firefox..."

    IF [ "$TARGETARCH" = "amd64" ]
        SET PLATFORM = "linux64"
        LET FIREFOX_URL = "${BASE_URL}/firefox/${version}/firefox_amd64.zip"
        LET GECKODRIVER_URL = "${BASE_URL}/firefox/${version}/geckodriver-v0.36.0-linux64.tar.gz"
    ELSE
        SET PLATFORM = "linux-aarch64"
        LET FIREFOX_URL = "${BASE_URL}/firefox/${version}/firefox_arm64.zip"
        LET GECKODRIVER_URL = "${BASE_URL}/firefox/${version}/geckodriver-v0.36.0-linux-aarch64.tar.gz"
    END

    RUN curl -sSL -o /tmp/firefox.zip ${FIREFOX_URL} \
        && unzip /tmp/firefox.zip -d /tmp \
        && gdebi -n /tmp/firefox*.deb \
        && rm -f /tmp/firefox.deb
    RUN firefox --version

    RUN printf "${BLUE} Installing Geckodriver..."
    RUN mkdir -p /opt/geckodriver
    RUN curl -sL ${GECKODRIVER_URL} | tar -xz -C /opt/geckodriver/
    RUN ln -s /opt/geckodriver/geckodriver /usr/bin/geckodriver
    RUN geckodriver --version

# There is no Edge version build for linux/arm64, installing only for amd64.
INSTALL_EDGE_LINUX64:
    FUNCTION

    ARG --required version
    ARG TARGETARCH
    LET BLUE ='\033[0;34m'

    IF [ "$TARGETARCH" = "amd64" ]
        RUN printf "${BLUE} Installing Edge..." \
            && curl -sSL -o /opt/edge.zip "${BASE_URL}/edge/${version}/edge_amd64.zip" \
            && unzip /opt/edge.zip -d /opt/edge \
            && gdebi -n /opt/edge/edge_amd64.deb \
            && rm -rf /opt/edge*
        RUN microsoft-edge --version

        RUN printf "${BLUE} Installing Edgedriver..." \
            && curl -sSL -o /opt/edgedriver.zip "${BASE_URL}/edge/${version}/edgedriver_linux64.zip" \
            && unzip -j /opt/edgedriver.zip -d /usr/local/bin/ \
            && rm -rf /opt/edgedriver.zip
        RUN msedgedriver --version
    END

# Installs the Chromium or Chromium driver.
# Both amd64 and arm64 are supported.
INSTALL_CHROMIUM:
    FUNCTION

    ARG --required version
    ARG --required PACKAGE_TYPE
    ARG --required DOWNLOAD_URL
    LET BLUE='\033[0;34m'

    IF [ "$PACKAGE_TYPE" = "chromium" ]
        RUN printf "${BLUE} Installing ${PACKAGE_TYPE} version: ${version}..." \
            && curl -sSL -o /opt/${PACKAGE_TYPE}.zip ${DOWNLOAD_URL} \
            && unzip /opt/${PACKAGE_TYPE}.zip -d /opt/${PACKAGE_TYPE} \
            && gdebi -n /opt/${PACKAGE_TYPE}/lib*.deb \
            && gdebi -n /opt/${PACKAGE_TYPE}/chromium-common*.deb \
            && gdebi -n /opt/${PACKAGE_TYPE}/chromium_*.deb \
            && rm -rf /opt/${PACKAGE_TYPE}*
    ELSE
        RUN printf "${BLUE} Installing ${PACKAGE_TYPE} version: ${version}..." \
            && curl -sSL -o /opt/${PACKAGE_TYPE}.zip ${DOWNLOAD_URL} \
            && unzip /opt/${PACKAGE_TYPE}.zip -d /opt/${PACKAGE_TYPE} \
            && gdebi -n /opt/${PACKAGE_TYPE}/*.deb \
            && rm -rf /opt/${PACKAGE_TYPE}.zip
    END

# based on https://github.com/GoogleChromeLabs/chrome-for-testing/issues/55#issuecomment-2369600641
INSTALL_CHROME_FOR_TESTING:
    FUNCTION

    ARG --required version
    ARG TARGETARCH
    LET BLUE ='\033[0;34m'

    IF [ "$TARGETARCH" = "amd64" ]
        RUN printf "${BLUE} Installing Chrome-for-testing..." \
            && curl -sSL -o /opt/chrome.zip "${BASE_URL}/chrome-for-testing/${version}/chrome-linux64.zip" \
            && unzip /opt/chrome.zip -d /opt/chrome \
            && mv /opt/chrome/chrome-linux64/* /opt/chrome \
            && rm -rf /opt/chrome/chrome-linux64 \
            && while read pkg; do apt-get satisfy -y --no-install-recommends "${pkg}"; done < /opt/chrome/deb.deps \
            && ln -s /opt/chrome/chrome /usr/local/bin/google-chrome \
            && rm -f /opt/chrome.zip
        RUN google-chrome --version

        RUN printf "${BLUE} Installing Chromedriver..." \
            && curl -sSL -o /opt/chromedriver.zip "${BASE_URL}/chrome-for-testing/${version}/chromedriver-linux64.zip" \
            && unzip -j /opt/chromedriver.zip -d /usr/local/bin/ \
            && rm -rf /opt/chromedriver.zip
        RUN chromedriver --version
    ELSE
        DO +INSTALL_CHROMIUM --version=$version --PACKAGE_TYPE="chromium" --DOWNLOAD_URL="${BASE_URL}/chromium/${version}/chromium_${TARGETARCH}.zip"
        RUN chromium --version
        DO +PATCH_CHROME --BIN_TO_PATCH="chromium"

        DO +INSTALL_CHROMIUM --version=$version --PACKAGE_TYPE="chromium-driver" --DOWNLOAD_URL="${BASE_URL}/chromium/${version}/chromium-driver-${TARGETARCH}.zip"
        RUN chromedriver --version
    END

PATCH_CHROME:
    FUNCTION
    ARG --required BIN_TO_PATCH
    # patch Chrome - workaround for https://github.com/flutter/flutter/issues/154727
    ENV CHROME_EXECUTABLE="/usr/local/bin/chrome-patch.sh"
    RUN printf "${BLUE} Creating a ${BIN_TO_PATCH} patch at ${CHROME_EXECUTABLE}..." \
        && echo '#!/bin/bash' > $CHROME_EXECUTABLE \
        && echo '/usr/bin/'$BIN_TO_PATCH' --no-sandbox --disable-gpu --disable-dev-shm-usage --headless --disable-extensions --disable-popup-blocking --incognito "$@"' >> $CHROME_EXECUTABLE \
        && chmod +x $CHROME_EXECUTABLE
