# cspell: words Zwasm

VERSION 0.8

IMPORT ../flutter AS flutter-ci
IMPORT ../rust AS rust-ci
IMPORT ../debian AS debian

# This will be refactored in the future
# TODO(bkioshn): https://github.com/input-output-hk/catalyst-ci/issues/322
# builder: Setup necessary tools for `flutter_rust_bridge`
builder:
    FROM debian+common

    DO debian+INSTALL --packages=clang

    WORKDIR /work

    DO flutter-ci+INSTALL_FLUTTER
    DO rust-ci+INSTALL_RUST
    DO rust-ci+INSTALL_TOOLS

# Generated necessary files for running Flutter web.
CODE_GENERATOR_WEB:
    FUNCTION
    ARG --required WASM_MODULE_NAME

    # TODO(dt-iohk): revert to official version when changes from the fork are merged into the official version
    GIT CLONE --branch feat/wasm-bindgen-configurable-module https://github.com/input-output-hk/catalyst_flutter_rust_bridge.git /usr/local/flutter_rust_bridge
    RUN cargo run --manifest-path /usr/local/flutter_rust_bridge/frb_codegen/Cargo.toml -- generate
    RUN cargo run --manifest-path /usr/local/flutter_rust_bridge/frb_codegen/Cargo.toml -- build-web --wasm-bindgen-args="--no-modules-global=$WASM_MODULE_NAME"

    # RUN flutter_rust_bridge_codegen generate
    # TODO(damian-molinski) add --release flag to the command below to optimize for performance
    # RUN flutter_rust_bridge_codegen build-web --wasm-bindgen-args="--no-modules-global=$WASM_MODULE_NAME"

    RUN mkdir -p assets/js && cp -rf ./web/pkg/* assets/js/
     # Don't want this gitignore file.
    RUN rm -rf ./assets/js/.gitignore

    # Reformat code once it's generated under lib directory.
    RUN dart format lib
