VERSION 0.8

IMPORT ../flutter AS flutter-ci
IMPORT ../rust AS rust-ci

# This will be refactored in the future
# TODO(bkioshn): https://github.com/input-output-hk/catalyst-ci/issues/322
builder:
    FROM debian:stable-slim

    WORKDIR /work

    RUN apt-get update \
        && apt-get install -y \
        apt-utils \
        wget \
        tar \
        xz-utils \
        git

    DO flutter-ci+INSTALL_FLUTTER
    DO rust-ci+INSTALL_RUST

    DO rust-ci+COPY_TOOL --tool="flutter-rust-bridge-codegen" --bin="flutter_rust_bridge_codegen"

    RUN flutter_rust_bridge_codegen --version

# Generated necessary files for running Flutter web.
code-generator-web:
    FROM +builder
    RUN flutter_rust_bridge_codegen generate
    RUN flutter_rust_bridge_codegen build-web

    SAVE ARTIFACT ./web/pkg pkg
    SAVE ARTIFACT ./rust/src/frb_generated.rs frb_generated
    SAVE ARTIFACT ./lib/src lib_src