VERSION 0.7
FROM golang:1.20-alpine3.18

# cspell: words udts onsi ldflags extldflags cytpoia gofmt golangci GOLANGCI GOCACHE errchkjson ginkgolinter goimports gosec nilnil testpackage

fmt:
    DO ../earthly/go+FMT --src="go.mod go.sum cmd pkg"

lint:
    DO ../earthly/go+LINT --src="go.mod go.sum cmd pkg"

deps:
    WORKDIR /work

    # Install external deps
    RUN apk add --no-cache gcc musl-dev

    # Install package dependencies
    COPY go.mod go.sum ./
    RUN go mod download

    # Make sure the ginkgo binary is available for the test stage
    RUN go install github.com/onsi/ginkgo/v2/ginkgo

    SAVE ARTIFACT go.mod AS LOCAL go.mod
    SAVE ARTIFACT go.sum AS LOCAL go.sum

src:
    FROM +deps

    COPY --dir cmd pkg .

test:
    FROM +src

    RUN ginkgo ./...

build:
    FROM +src

    ENV CGO_ENABLED=0
    RUN go build -ldflags="-extldflags=-static" -o bin/ci cmd/main.go

    SAVE ARTIFACT bin/ci ci

docker:
    FROM debian:bookworm-slim
    WORKDIR /workspace

    COPY +build/ci /usr/local/bin/ci

    ENTRYPOINT ["/usr/local/bin/ci"]

check:
    FROM +deps

    BUILD +fmt
    BUILD +lint
    BUILD +test

release:
    FROM +build

    SAVE ARTIFACT bin/ci ci

publish:
    FROM +docker
    ARG tag=latest

    SAVE IMAGE --push ci-cli:${tag}